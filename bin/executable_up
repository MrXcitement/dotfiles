#!/bin/bash

# up - A script to manage and run other 'up-*' scripts.
# Mike Barker <mike@thebarkers.com>
# Created: May 22nd, 2025
# Updated: November 30th, 2025

# Error Handling
set -euo pipefail

version="1.1.1"
script_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"

# Display help message
show_help() {
    echo "Usage: up [COMMAND] [-h|--help] [-V|--version]"
    echo ""
    echo "Runs specific 'up-*' scripts."
    echo ""
    echo "Commands:"
    echo "  <command>    Runs the 'up-<command>' script in the same directory."
    echo ""
    echo "Options:"
    echo "  -h, --help    Display this help message and exit."
    echo "  -l, --list    List the scripts that can be run."
    echo "  -V, --version Display version information and exit."
    echo ""
    echo "Examples:"
    echo "  up brew      # Runs the 'up-brew' script"
}

# List scripts
list_scripts() {

    # Find all executable files starting with 'up-'
    if [[ $(uname -s) == "Darwin" ]]; then 
        local perm_arg=+111
    else
        local perm_arg=/111
    fi
    local scripts=($(find "$script_dir" -type f -perm $perm_arg -name 'up-*' | sort))

    # List all executable up-* scripts
    for script_path in "${scripts[@]}"; do
        local script_base_name=$(basename "$script_path")
        local command_name="${script_base_name#up-}"
        echo "$command_name"
    done
}

# Run a specific up script
run_script() {
    local script_name="up-$1"
    local script_path="$script_dir/$script_name"

    if [ -x "$script_path" ]; then
        echo "--> Running $script_name..."
        "$script_path"
    else
        echo "Error: Script '$script_name' not found or not executable in $script_dir"
        exit 1
    fi
}

# Display help if no arguments given
if [ "$#" -eq 0 ]; then
    show_help
    exit 0
fi

# Parse arguments
case "$1" in
    -h|--help)
        show_help
        exit 0
        ;;
    -l|--list)
        list_scripts
        exit 0
        ;;
    -V|--version)
        echo "up version $version"
        exit 0
        ;;
    *)
        run_script "$1"
        exit 0
        ;;
esac
