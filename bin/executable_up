#!/bin/bash

# up - A script to manage and run other 'up-*' scripts.
# Mike Barker <mike@thebarkers.com>
# Created: May 22nd, 2025
# Updated: November 30th, 2025

# Error Handling
set -euo pipefail

version="1.2.1"
script_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"

# Display help message
show_help() {
    echo "Usage: up [COMMAND] [OPTIONS]"
    echo
    echo "Commands:"
    echo "  up <script>        Run a specific up-* script"
    echo
    echo "Options:"
    echo "  -a, --all          Run all up-* scripts"
    echo "  -l, --list         List available up-* scripts"
    echo "  -h, --help         Show this help message"
    echo "  -V, --version      Show script version"
}


# List all up-* executable scripts
list_scripts() {

    # Find all executable files starting with 'up-'
    for f in "$script_dir"/up-*; do
        [[ -f "$f" && -x "$f" && "$(basename "$f")" != "up" ]] || continue
        local name="$(basename "$f")"
        echo "${name#up-}"
    done | sort
}

# Run a specific up script
run_script() {
    local script_name="up-$1"
    local script_path="$script_dir/$script_name"

    if [ -x "$script_path" ]; then
        "$script_path"
    else
        echo "Error: Script '$script_name' not found or not executable in $script_dir"
        exit 1
    fi
}

# Run all up-* executable scripts
run_all_scripts() {
    while IFS= read -r script; do
        "$script_dir/up-$script"
	echo
    done < <(list_scripts)
}

# Display help if no arguments given
if [ "$#" -eq 0 ]; then
    show_help
    exit 0
fi

# Parse arguments
case "$1" in
    -a|--all)
        run_all_scripts
        ;;
    -h|--help)
        show_help
        exit 0
        ;;
    -l|--list)
        list_scripts
        exit 0
        ;;
    -V|--version)
        echo "up version $version"
        exit 0
        ;;
    *)
        run_script "$1"
        exit 0
        ;;
esac
