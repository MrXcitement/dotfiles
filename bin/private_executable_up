#!/usr/bin/env bash

# up - A script to manage and run other 'update' scripts.
# Mike Barker <mike@thebarkers.com>
# Created: May 22nd, 2025
# Updated: January 21st, 2026

# Error Handling
set -euo pipefail

version="1.3.0"
script_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"

# Display help message
show_help() {
    echo "Usage: up [COMMAND] [OPTIONS]"
    echo
    echo "Commands:"
    echo "  up <script>        Run a specific update script"
    echo
    echo "Options:"
    echo "  -a, --all          Run all update scripts"
    echo "  -l, --list         List available update scripts"
    echo "  -h, --help         Show this help message"
    echo "  -V, --version      Show script version"
}


# List all update executable scripts
list_scripts() {

    local name

    # Find all executable files starting with 'up-'
    for f in "$script_dir"/up-*; do
        [[ -f "$f" && -x "$f" && "$(basename "$f")" != "up" ]] || continue
        name="$(basename "$f")"
        echo "${name#up-}"
    done | sort
}

# Run a specific up script
run_script() {
    local script_name="up-$1"
    local script_path="$script_dir/$script_name"

    if [ -x "$script_path" ]; then
        "$script_path"
    else
        echo "Error: Script '$script_name' not found or not executable in $script_dir"
        exit 1
    fi
}

# Run all update executable scripts
# Runs the script in a sub-shell to keep any side effects when running
# the script from causing this script to fail.
run_all_scripts() {
    local script
    local all_scripts

    all_scripts=$(list_scripts)

    for script in $all_scripts; do
        (
            if ! "$script_dir/up-$script"  </dev/null; then
                printf 'Warning: up-%s failed.\n' "$script" >&2
            fi
        )
        echo
    done
}

# Display help if no arguments given
if [ "$#" -eq 0 ]; then
    show_help
    exit 0
fi

# Parse arguments
case "$1" in
    -a|--all)
        run_all_scripts
        ;;
    -h|--help)
        show_help
        exit 0
        ;;
    -l|--list)
        list_scripts
        exit 0
        ;;
    -V|--version)
        echo "up version $version"
        exit 0
        ;;
    *)
        run_script "$1"
        exit 0
        ;;
esac
